<template>
  <!-- 标题 -->
  <div class="flex items-center gap-2 py-5 px-8 border-b">
    <div class="w-5 h-5 rounded-full" :style="{ backgroundColor: experimentStore.color }"></div>
    <h1 class="text-lg font-semibold">{{ experimentStore.name }}</h1>
    <SLStatusLabel :status="experimentStore.status" />
  </div>
  <!-- 图表容器 -->
  <ChartsContainer :label="t('experiment.chart.label.default')" :count="tags?.length" v-if="showContainer(tags)">
    <!-- TODO 后续多数据源的时候，这里需要改变sources的保存逻辑 -->
    <G2Chart v-for="(tag, index) in tags" :key="index" :sources="[tag]" />
  </ChartsContainer>
</template>

<script setup>
/**
 * @description: 实验-图表页
 * @file: ChartPage.vue
 * @since: 2023-12-09 20:39:41
 **/
import { ref } from 'vue'
import { useExperimentStroe } from '@swanlab-vue/store'
import SLStatusLabel from '@swanlab-vue/components/SLStatusLabel.vue'
import ChartsContainer from './components/ChartsContainer.vue'
import G2Chart from './components/G2Chart.vue'
import http from '@swanlab-vue/api/http'
import { onUnmounted } from 'vue'
import { t } from '@swanlab-vue/i18n'
const experimentStore = useExperimentStroe()
// ---------------------------------- 初始化：获取图表配置 ----------------------------------
const tags = ref()
// 用于设置轮询
let timer = undefined

/**
 * 根据id获取实验，如果id不传，默认使用experimentId
 * 如果实验正在进行，开启轮询
 * @param { string } id 实验id
 */
const getExperiment = (id = experimentStore.id) => {
  http.get('/experiment/' + id).then(({ data }) => {
    // 判断data.tags和tags是否相同，如果不同，重新渲染
    if (data.tags.join('') !== tags.value?.join('')) {
      // console.log('不同，重新渲染', data.tags, tags.value)
      tags.value = data.tags
    }
    // 如果status为0，且timer为undefined，开启轮询
    // 如果不为0且timer不为undefined，关闭轮询
    experimentStore.setStatus(data.status)
    if (data.status === 0 && !timer) {
      timer = setInterval(() => {
        getExperiment(id)
      }, 5000)
    } else if (data.status !== 0 && timer) {
      clearInterval(timer)
    }
  })
}
// 立即执行
getExperiment()

onUnmounted(() => {
  clearInterval(timer)
})

// ---------------------------------- 判断某个namespcace下是否存在图表 ----------------------------------
const showContainer = (sources) => {
  return !!sources?.length
}
</script>

<style lang="scss" scoped></style>
